# lessons.md（学びの記録 / 再発防止）

このファイルは、QA4AIDD Gate + Coach 開発における「学び」「失敗パターン」「再発防止策」を蓄積する。
目的は、同じ問題（曖昧・契約不整合・証跡不足・形骸化）を繰り返さないこと。

---

## 1. 失敗はAIではなく“指示/定義の構造不足”から起きる

### 観測される失敗

- 仕様が曖昧 → 実装が解釈違い → 手戻り
- 判断根拠が残らない → 後で説明できない
- QA観点が属人化 → レビュー品質が揺れる

### 再発防止

- 先に **9つの基盤ドキュメント**（定義書6 + 記憶3）を揃える
- 成果物の結合点（例：`checklistresults.json`）は **契約（スキーマ）として固定**する

---

## 1.1 教訓：ドキュメントは「希望」ではなく「事実契約」である

### 失敗パターン

- docsに「G1/G2/G5がある」と書いているが、実体（コード/pack）が追随していない
- docsに「Allureが出る」と書いているが、Phase 1 では `output/` が正でAllure統合が未整備

### 再発防止

- docsには必ず「Phase 1の正の出力」「未実装は未実装」を書く
- “将来やる”は **将来** と明記し、現状の仕様と混ぜない

---

## 2. 「判断=人 / 検証=自動 / 証跡=システム」を崩さない

### よくある崩れ方

- 自動スコア（DeepEval等）を合否の唯一根拠にしてしまう
- Done/Abortの理由が形骸化（空欄/テンプレだけ）

### 再発防止

- Coach UIで **Abort理由必須** をUIで強制
- スコアは **0.70未満Warning** を原則にしつつ、最終はDone/Abortで確定

---

## 3. AIのHow（モデル/プロンプト/RAG）を上流に持ち込まない

### 失敗パターン

- 企画/要件に「モデルAを使う」「RAGは〜」が混ざり、
  仕様（Why/What）と実装（How）が混線する

### 再発防止

- 企画/要件は **Why/What/受入条件/運用宣言** に集中
- Howは設計/実装で扱う（隔離）

---

## 4. データ契約（JSON/YAML）はプロダクトの一部

### 失敗パターン

- UIが出すJSONとRunnerが読むJSONが違い、接続できない
- パスや命名がばらつき、CIで再現できない

### 再発防止

- `checklistresults.json` を契約として固定（スキーマ/サンプル/検証）
- 出力は機械可読（JSON）で統一し、保存先・命名規則を決める

---

## 7. 今回の修正（2026-03-01）

- PRDが `/docs` から欠落していたため再生成し、契約（データ・出力・非ゴール）を再固定した
- `runner/aidd-gate.py` を正の実装として明記し、空ファイル（g1/g2/g5）を「未整備」としてドキュメントに反映した

---

## 8. CHK-PLN-AIDD-001 適用の学び（2026-03-01）

### AIを使うツールはAIDD品質チェックを自己適用する

本ツールは G4（DeepEval）/ PF を使う AI 活用製品でもある。
`CHK-PLN-AIDD-001.yaml` の品質観点は外部成果物の評価だけでなく、**このツール自体にも適用する**。

### 見落としやすいカテゴリ（AI担当者への注意）

| カテゴリ | 落ちやすい観点 | 対処 |
|---|---|---|
| CAT-050 失敗モード | G4スコアの幻覚・誤評価 | スコアを唯一根拠にしない（§12 ポリシーで対処済） |
| CAT-080 コスト/フェイルセーフ | G4/PF利用不可時にCIが止まる | SKIP/WARNで継続（BACKEND §5.5で対処済） |
| CAT-020 データ最小化 | 機密成果物をそのまま外部LLMへ送信 | 送信可否確認・最小テキスト送信のポリシー追加済 |
| CAT-040 ゴールドデータ | 評価基準が曖昧なまま運用 | Phase 4 実装時に担当者・更新頻度を確定する |

### 再発防止

- 新しいAI機能（ゲート・評価ツール）を追加する際は、`CHK-PLN-AIDD-001.yaml` の全カテゴリを自己チェックする
- 特に CAT-080（フェイルセーフ）と CAT-020（データ最小化）は忘れやすい

---

## 5. 段階導入（Coach先行）は“導入戦略”である

### 学び

- CI/Dockerが使えない層が存在する前提では、
  **教育（視座共有）→ 自動化** の順が現実的

### 再発防止

- Phase 1はサーバ不要・ローカルで成立するように設計する
- いきなりCI前提にしない（ただし、後でCI接続できるよう出力は機械可読にする）

---

## 6. 実務のチェック（短縮版）

- 変更を入れる前に、必ず参照する：
  - `docs/PRD.md`（何を作るか）
  - `docs/BACKEND_ARCHITECTURE.md`（どう繋がるか）
  - `docs/CLAUDE.md`（守る契約）
- 追加の成果物が必要なら、まず契約とIDを決める
